/* ----------------------------------------------------------------------
 * File            : gamma.c                       
 * Author          : Lavergne Thomas                          
 * Creation Date   : 25 May 2005                            
 * Purpose         :                                  
 * 	Routines and data types for the calculation of appropriate gamma
 * 	coefficient (as in Table 4)
 * -----------------------------------------------------------------------
 */

#include <stdio.h>
#include <math.h>

#include "commonrad.h"
#include "common.h"
#include "interf.h"
#include "gammaproc.h"
#include "gamma.h"
   

void FullGammas(const struct RTContext *ct,
      double *tauprimetilde,double *tauprimestar,double *gamma,double *gamma_star) 
{
 
   if (ct->tta != ISOLIGHT ) {
      gammas(ct->rl,ct->tl,cos(ct->tta_rad),gamma);
      *tauprimetilde = 0.5*ct->lai*ct->zeta;
   }
   gammas(ct->rl,ct->tl,0.5/0.705,gamma_star);
   *tauprimestar = 0.5*ct->lai*ct->zeta_star;
}

void DblGammas(const struct RTContext *ct,
      double *tauprimetilde,double *tauprimestar,double *gamma,double *gamma_star) 
{
   FullGammas(ct,tauprimetilde,tauprimestar,gamma,gamma_star);
   gamma[1] = gamma_star[1] = 0.;
}

void SglGammas(const struct RTContext *ct,
      double *tauprimetilde,double *tauprimestar,double *gamma,double *gamma_star) 
{
   DblGammas(ct,tauprimetilde,tauprimestar,gamma,gamma_star);
   gamma[0] = gamma_star[0] = 2.;
}

static double Gmu0Planophile[91][2] = 
{{0.0000000,0.84882641},
{1.0000000,0.84869702},
{2.0000000,0.84830924},
{3.0000000,0.84766332},
{4.0000000,0.84675983},
{5.0000000,0.84559860},
{6.0000000,0.84417987},
{7.0000000,0.84250797},
{8.0000000,0.84058245},
{9.0000000,0.83840224},
{10.000000,0.83596748},
{11.000000,0.83327863},
{12.000000,0.83035020},
{13.000000,0.82717942},
{14.000000,0.82376239},
{15.000000,0.82009837},
{16.000000,0.81618745},
{17.000000,0.81203017},
{18.000000,0.80765143},
{19.000000,0.80305902},
{20.000000,0.79823898},
{21.000000,0.79318798},
{22.000000,0.78790483},
{23.000000,0.78238934},
{24.000000,0.77664189},
{25.000000,0.77069401},
{26.000000,0.76458408},
{27.000000,0.75828011},
{28.000000,0.75177354},
{29.000000,0.74506061},
{30.000000,0.73813956},
{31.000000,0.73100975},
{32.000000,0.72367123},
{33.000000,0.71618334},
{34.000000,0.70859869},
{35.000000,0.70086627},
{36.000000,0.69297213},
{37.000000,0.68490953},
{38.000000,0.67667474},
{39.000000,0.66826571},
{40.000000,0.65968143},
{41.000000,0.65094456},
{42.000000,0.64221293},
{43.000000,0.63341199},
{44.000000,0.62451059},
{45.000000,0.61549513},
{46.000000,0.60635786},
{47.000000,0.59709400},
{48.000000,0.58770052},
{49.000000,0.57817559},
{50.000000,0.56864974},
{51.000000,0.55920836},
{52.000000,0.54975379},
{53.000000,0.54025822},
{54.000000,0.53070696},
{55.000000,0.52109083},
{56.000000,0.51140371},
{57.000000,0.50164137},
{58.000000,0.49185124},
{59.000000,0.48228922},
{60.000000,0.47282426},
{61.000000,0.46340577},
{62.000000,0.45401010},
{63.000000,0.44462285},
{64.000000,0.43523427},
{65.000000,0.42583742},
{66.000000,0.41650408},
{67.000000,0.40751730},
{68.000000,0.39871782},
{69.000000,0.39004914},
{70.000000,0.38148376},
{71.000000,0.37300449},
{72.000000,0.36459943},
{73.000000,0.35629063},
{74.000000,0.34844430},
{75.000000,0.34091042},
{76.000000,0.33361008},
{77.000000,0.32650832},
{78.000000,0.31958385},
{79.000000,0.31282228},
{80.000000,0.30660132},
{81.000000,0.30084475},
{82.000000,0.29543942},
{83.000000,0.29034316},
{84.000000,0.28553554},
{85.000000,0.28142260},
{86.000000,0.27789961},
{87.000000,0.27485907},
{88.000000,0.27240620},
{89.000000,0.27086455},
{90.000000,0.27018975}};


static double Gmu0Erectophile[91][2] = 
{{0.0000000,0.42441320},
{1.0000000,0.42445920},
{2.0000000,0.42454918},
{3.0000000,0.42465832},
{4.0000000,0.42498203},
{5.0000000,0.42527334},
{6.0000000,0.42547761},
{7.0000000,0.42592600},
{8.0000000,0.42652515},
{9.0000000,0.42712321},
{10.000000,0.42767072},
{11.000000,0.42814196},
{12.000000,0.42888727},
{13.000000,0.42980269},
{14.000000,0.43075458},
{15.000000,0.43169199},
{16.000000,0.43258535},
{17.000000,0.43341517},
{18.000000,0.43441922},
{19.000000,0.43565813},
{20.000000,0.43696638},
{21.000000,0.43828961},
{22.000000,0.43959597},
{23.000000,0.44086378},
{24.000000,0.44207714},
{25.000000,0.44337346},
{26.000000,0.44492468},
{27.000000,0.44656108},
{28.000000,0.44822744},
{29.000000,0.44989226},
{30.000000,0.45153394},
{31.000000,0.45313632},
{32.000000,0.45468675},
{33.000000,0.45632172},
{34.000000,0.45816171},
{35.000000,0.46006914},
{36.000000,0.46199938},
{37.000000,0.46392610},
{38.000000,0.46583078},
{39.000000,0.46769923},
{40.000000,0.46952007},
{41.000000,0.47131480},
{42.000000,0.47328800},
{43.000000,0.47533124},
{44.000000,0.47739506},
{45.000000,0.47945405},
{46.000000,0.48149097},
{47.000000,0.48349278},
{48.000000,0.48544904},
{49.000000,0.48735103},
{50.000000,0.48928883},
{51.000000,0.49131954},
{52.000000,0.49336502},
{53.000000,0.49539925},
{54.000000,0.49740617},
{55.000000,0.49937408},
{56.000000,0.50129374},
{57.000000,0.50315749},
{58.000000,0.50497898},
{59.000000,0.50685582},
{60.000000,0.50873102},
{61.000000,0.51058015},
{62.000000,0.51238981},
{63.000000,0.51415056},
{64.000000,0.51585501},
{65.000000,0.51749709},
{66.000000,0.51908742},
{67.000000,0.52068047},
{68.000000,0.52224013},
{69.000000,0.52375166},
{70.000000,0.52520656},
{71.000000,0.52659862},
{72.000000,0.52792294},
{73.000000,0.52917836},
{74.000000,0.53039710},
{75.000000,0.53156223},
{76.000000,0.53266390},
{77.000000,0.53369670},
{78.000000,0.53465673},
{79.000000,0.53554090},
{80.000000,0.53636137},
{81.000000,0.53711341},
{82.000000,0.53779116},
{83.000000,0.53839167},
{84.000000,0.53891288},
{85.000000,0.53935792},
{86.000000,0.53972451},
{87.000000,0.54001056},
{88.000000,0.54021523},
{89.000000,0.54033852},
{90.000000,0.54037963}};


static double interpGmu(const double tta,double Gmu[91][2])
{
   int pos = (int)(tta);
   double dist = tta - (double)pos;
   return ((1.-dist)*Gmu[pos][1] + dist*Gmu[pos+1][1]);
}

void PlanoGammas(const struct RTContext *ct,
      double *tauprimetilde,double *tauprimestar,double *gamma,double *gamma_star) 
{
   double wd  = ct->rl - ct->tl;
   double w0  = ct->rl + ct->tl;
   double w0half  = w0*0.5;
   double wdcorr  = wd*3./8.;
   double muBar = 0.9065;
   double mu0;
   double Gmu0_star;

   if (ct->tta != ISOLIGHT ) {
      /* interpolate the planophile data to the asked sun zenith angle */
      double Gmu0=interpGmu(ct->tta,Gmu0Planophile);
      gamma[0] = (1. - w0half + wdcorr)/(muBar*Gmu0);
      gamma[1] = (w0half + wdcorr)/(muBar*Gmu0);
      gamma[2] = (w0half + cos(ct->tta_rad)*wdcorr/Gmu0)/w0;
      gamma[3] = 1. - gamma[2];
      *tauprimetilde = ct->lai * Gmu0; 
   }
   mu0=0.5/0.705;
   Gmu0_star=interpGmu(rad2deg(acos(mu0)),Gmu0Planophile);
   gamma_star[0] = (1. - w0half + wdcorr)/(muBar*Gmu0_star);
   gamma_star[1] = (w0half + wdcorr)/(muBar*Gmu0_star);
   gamma_star[2] = (w0half + mu0*wdcorr/Gmu0_star)/w0;
   gamma_star[3] = 1. - gamma_star[2];
   *tauprimestar = ct->lai * Gmu0_star;

}

void ErectoGammas(const struct RTContext *ct,
      double *tauprimetilde,double *tauprimestar,double *gamma,double *gamma_star)
{
   double wd  = ct->rl - ct->tl;
   double w0  = ct->rl + ct->tl; 
   double w0half  = w0*0.5;
   double wdcorr  = wd/8.;
   double muBar = 1.046;
   double mu0;
   double Gmu0_star;
   
   if (ct->tta != ISOLIGHT ) {
      double Gmu0=interpGmu(ct->tta,Gmu0Erectophile);
      gamma[0] = (1. - w0half + wdcorr)/(muBar*Gmu0);
      gamma[1] = (w0half + wdcorr)/(muBar*Gmu0);
      gamma[2] = (w0half + cos(ct->tta_rad)*wdcorr/Gmu0)/w0;
      gamma[3] = 1. - gamma[2];
      *tauprimetilde = ct->lai * Gmu0;
   }

   mu0=0.5/0.705;
   Gmu0_star=interpGmu(rad2deg(acos(mu0)),Gmu0Erectophile);
   gamma_star[0] = (1. - w0half + wdcorr)/(muBar*Gmu0_star);
   gamma_star[1] = (w0half + wdcorr)/(muBar*Gmu0_star);
   gamma_star[2] = (w0half + mu0*wdcorr/Gmu0_star)/w0;
   gamma_star[3] = 1. - gamma_star[2];
   *tauprimestar = ct->lai * Gmu0_star;

}
